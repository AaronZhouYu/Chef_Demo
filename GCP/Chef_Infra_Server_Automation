sudo apt update && sudo apt upgrade -y

curl https://packages.chef.io/files/current/latest/chef-automate-cli/chef-automate_linux_amd64.zip | gunzip - > chef-automate && chmod +x chef-automate

sudo sysctl -w vm.max_map_count=262144
sudo sysctl -w vm.dirty_expire_centisecs=20000

#To make these changes permanent, add the following to /etc/sysctl.conf:
#vm.max_map_count=262144
#vm.dirty_expire_centisecs=20000

sudo chef-automate deploy --product automate --product infra-server
sudo chef-automate init-config

#Add a stanza to the configuration file to deploy Chef Automate and Chef Infra Server:
sudo vi config.toml
#  [deployment.v1.svc]
#  products=["automate", "infra-server"]
#  [global.v1]
#  fqdn = "your-instance-public-ip-address"

sudo chef-automate config set config.toml
sudo chef-automate config show

#To extract login credentials <username> and <password>
sudo cat automate-credentials.toml

#Now, you can access your Chef Automate WEB UI - https://"your-instance-public-ip-address"

#Create a new directory that will house the necessary security keys for Chef Infra.
sudo mkdir -p ~/.chef
#sudo chef-server-ctl user-create USER_NAME FIRST_NAME LAST_NAME EMAIL 'PASSWORD' --filename USER_NAME.pem
sudo chef-server-ctl user-create aaron Yu Zhou aaron.zhouyu@gmail.com 'passw0rd' --filename ~/.chef/aaron.pem
#sudo chef-server-ctl org-create SHORT_NAME 'FULL_ORGANIZATION_NAME' --association_user USER_NAME --filename ORGANIZATION-validator.pem
sudo chef-server-ctl org-create chef_demo 'Chef Demo' --association_user aaron --filename chef_demo.pem

#Switch to the Chef WorkStation, and use SCP to copy the generated USER_NAME.pem and ORGANIZATION-validator.pem to ~/.chef, and create config.rb file and get SSL certs from the Chef Infra Server
